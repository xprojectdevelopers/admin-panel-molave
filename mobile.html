<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mobile Admin Panel</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: #f5f7fa;
      color: #111827;
      margin: 0;
      padding: 2rem 1rem;
      max-width: 900px;
      margin-inline: auto;
    }

    /* ✅ LOGIN OVERLAY */
    #loginOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #loginBox {
      background: #ffffff;
      padding: 2rem 2.5rem;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      text-align: center;
      width: 320px;
    }

    #loginBox h2 {
      margin-bottom: 1.2rem;
      color: #1f2937;
    }

    #loginBox input {
      width: 100%;
      margin-bottom: 1rem;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      outline: none;
      font-size: 0.95rem;
      transition: border 0.2s;
    }

    #loginBox input:focus { border-color: #2563eb; }

    #loginBox button {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
      width: 100%;
    }

    #loginBox button:hover {
      transform: scale(1.03);
      background: linear-gradient(135deg, #1e40af, #2563eb);
    }

    #loginError {
      color: #ef4444;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: none;
    }

    /* ✅ NAVIGATION */
    nav {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    nav a {
      color: #2563eb;
      font-weight: 600;
      text-decoration: none;
      position: relative;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    nav a:hover { color: #1d4ed8; }

    nav a::after {
      content: "";
      position: absolute;
      width: 0%;
      height: 2px;
      bottom: -4px;
      left: 0;
      background-color: #2563eb;
      transition: width 0.3s;
      border-radius: 2px;
    }

    nav a:hover::after,
    nav a.active::after { width: 100%; }

    hr {
      border: none;
      height: 1px;
      background: #e5e7eb;
      margin-bottom: 1.5rem;
    }

    /* ✅ SECTIONS */
    section {
      display: none;
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      animation: fadeIn 0.3s ease-in-out;
    }

    section.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    section h2 {
      margin-bottom: 1rem;
      font-size: 1.3rem;
      color: #1f2937;
    }

    /* ✅ FORM */
    .form {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.2rem;
    }

    .form input {
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      outline: none;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .form input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.2);
    }

    .form button {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .form button:hover {
      background: linear-gradient(135deg, #1e40af, #2563eb);
      transform: scale(1.03);
    }

    /* ✅ LIST */
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 10px;
    }

    li {
      background: #f9fafb;
      padding: 12px 16px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    li:hover { background: #eef2ff; transform: translateY(-2px); }

    li img {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    li span {
      flex: 1;
      margin-left: 1rem;
      color: #1f2937;
      font-weight: 500;
    }

    li button {
      background: #ef4444;
      border: none;
      padding: 8px 14px;
      color: white;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    li button:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    /* ✅ RESPONSIVE */
    @media (max-width: 640px) {
      body { padding: 1rem; }
      li { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      li img { width: 100%; max-height: 180px; border-radius: 12px; }
      li button { align-self: flex-end; }
    }
  </style>
</head>
<body>
  <!-- ✅ LOGIN OVERLAY -->
  <div id="loginOverlay">
    <div id="loginBox">
      <h2>Admin Login</h2>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p id="loginError">Invalid credentials. Try again.</p>
    </div>
  </div>

  <!-- ✅ NAVBAR -->
  <nav>
    <a onclick="showPanel('albums')" class="active">Albums</a>
    <a onclick="showPanel('announcements')">Announcements</a>
  </nav>
  <hr/>

  <!-- ✅ ALBUMS -->
  <section id="albums" class="active">
    <h2>Manage Face Shapes & Hairstyles</h2>
    <div class="form">
      <input type="file" id="albumFile" accept="image/*" />
      <input type="text" id="albumTitle" placeholder="Enter face shape (e.g. Round)" />
      <input type="text" id="albumDesc" placeholder="Enter hairstyle (e.g. Mullet)" />
      <button onclick="uploadAlbumImage()">Upload Image + Text</button>
    </div>
    <ul id="albumList"></ul>
  </section>

  <!-- ✅ ANNOUNCEMENTS -->
  <section id="announcements">
    <h2>Manage Monthly Announcements</h2>
    <div class="form">
      <input type="file" id="announcementFile" accept="image/*" />
      <button onclick="uploadAnnouncementImage()">Upload Announcement Image</button>
    </div>
    <ul id="announcementList"></ul>
  </section>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const ADMIN_USER = "molavestreetbarbers";
    const ADMIN_PASS = "molavestreetbarbers123";

    let supabase;
    const ALBUM_BUCKET = "album_mobile";
    const ANNOUNCEMENT_BUCKET = "monthly_announcement";
    const ANNOUNCEMENT_TABLE = "announcement";

    // ✅ Login
    window.login = function () {
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value.trim();
      const err = document.getElementById("loginError");

      if (u === ADMIN_USER && p === ADMIN_PASS) {
        document.getElementById("loginOverlay").style.display = "none";
        sessionStorage.setItem("adminLoggedIn", "true");
        initSupabase();
      } else err.style.display = "block";
    };

    window.addEventListener("load", () => {
      if (sessionStorage.getItem("adminLoggedIn") === "true") {
        document.getElementById("loginOverlay").style.display = "none";
        initSupabase();
      }
    });

    // ✅ Show Sections
    window.showPanel = function(id) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");

      document.querySelectorAll("nav a").forEach(a => a.classList.remove("active"));
      event.target.classList.add("active");
    };

    // ✅ Supabase Init
    async function initSupabase() {
      const res = await fetch("/api/config");
      const config = await res.json();
      supabase = createClient(config.SUPABASE_URL, config.SUPABASE_KEY);
      loadAlbum();
      loadAnnouncement();
    }

    // ✅ Album Logic
    async function loadAlbum() {
      const list = document.getElementById("albumList");
      const { data, error } = await supabase.from(ALBUM_BUCKET).select("*").order("created_at", { ascending: false });
      if (error) return (list.innerHTML = `<p>❌ ${error.message}</p>`);
      list.innerHTML = "";
      data.forEach(img => {
        const li = document.createElement("li");
        li.innerHTML = `
          <img src="${img.image_url}" alt="Image">
          <span>${img.title_caption || ""} ${img.desc_caption ? `- ${img.desc_caption}` : ""}</span>
          <button onclick="deleteAlbum(${img.id}, '${img.image_url}')">Delete</button>
        `;
        list.appendChild(li);
      });
    }

    window.uploadAlbumImage = async function() {
      const file = document.getElementById("albumFile").files[0];
      const title = document.getElementById("albumTitle").value.trim();
      const desc = document.getElementById("albumDesc").value.trim();
      if (!file) return alert("⚠️ Please select an image.");

      const filePath = `${Date.now()}-${file.name}`;
      const { error: uploadError } = await supabase.storage.from(ALBUM_BUCKET).upload(filePath, file);
      if (uploadError) return alert(uploadError.message);

      const { data: { publicUrl } } = supabase.storage.from(ALBUM_BUCKET).getPublicUrl(filePath);
      const { error: dbError } = await supabase.from(ALBUM_BUCKET).insert({
        image_url: publicUrl, title_caption: title, desc_caption: desc
      });
      if (dbError) return alert(dbError.message);

      alert("✅ Image uploaded!");
      document.getElementById("albumFile").value = "";
      document.getElementById("albumTitle").value = "";
      document.getElementById("albumDesc").value = "";
      loadAlbum();
    };

    window.deleteAlbum = async function(id, url) {
      const file = url.split("/").pop();
      await supabase.storage.from(ALBUM_BUCKET).remove([file]);
      await supabase.from(ALBUM_BUCKET).delete().eq("id", id);
      alert("✅ Deleted!");
      loadAlbum();
    };

    // ✅ Announcement Logic
    async function loadAnnouncement() {
      const list = document.getElementById("announcementList");
      const { data, error } = await supabase.from(ANNOUNCEMENT_TABLE).select("*").order("created_at", { ascending: false });
      if (error) return (list.innerHTML = `<p>❌ ${error.message}</p>`);
      list.innerHTML = "";
      data.forEach(img => {
        const li = document.createElement("li");
        li.innerHTML = `<img src="${img.image_url}"><button onclick="deleteAnnouncement(${img.id}, '${img.image_url}')">Delete</button>`;
        list.appendChild(li);
      });
    }

    window.uploadAnnouncementImage = async function() {
      const file = document.getElementById("announcementFile").files[0];
      if (!file) return alert("⚠️ Please select an image.");

      const filePath = `${Date.now()}-${file.name}`;
      const { error: uploadError } = await supabase.storage.from(ANNOUNCEMENT_BUCKET).upload(filePath, file);
      if (uploadError) return alert(uploadError.message);

      const { data: { publicUrl } } = supabase.storage.from(ANNOUNCEMENT_BUCKET).getPublicUrl(filePath);
      await supabase.from(ANNOUNCEMENT_TABLE).insert({ image_url: publicUrl });
      alert("✅ Announcement uploaded!");
      loadAnnouncement();
    };

    window.deleteAnnouncement = async function(id, url) {
      const file = url.split("/").pop();
      await supabase.storage.from(ANNOUNCEMENT_BUCKET).remove([file]);
      await supabase.from(ANNOUNCEMENT_TABLE).delete().eq("id", id);
      alert("✅ Deleted!");
      loadAnnouncement();
    };
  </script>
</body>
</html>
